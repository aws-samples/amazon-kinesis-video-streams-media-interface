name: cmake

on:
  workflow_run:
    workflows: [ ecr-prepare ]
    branches: [ main ]
    types:
      - completed

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  cmake:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container: [ "482862934379.dkr.ecr.us-east-1.amazonaws.com/ingenic:4.7.2", "482862934379.dkr.ecr.us-east-1.amazonaws.com/ingenic:5.4.0" ]
    container:
      image: ${{ matrix.container }}
      credentials:
        username: ${{ secrets.ECR_USERNAME }}
        password: ${{ secrets.ECR_PASSWORD }}

    steps:
    - name: Git checkout
      uses: actions/checkout@v2

    - name: Prepare board SDK
      run: |
        cp -r /ingenic-sdk/* ${GITHUB_WORKSPACE}/3rdparty/T31/

    - name: Configure CMake
      run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DBUILD_WEBRTC_SAMPLES=ON -DBUILD_KVS_SAMPLES=ON -DBUILD_SAVE_FRAME_SAMPLES=ON

    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config ${{ env.BUILD_TYPE }} --parallel 4

    - name: Test
      run: ctest -C ${{ env.BUILD_TYPE }}
